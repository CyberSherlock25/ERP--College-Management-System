{% extends 'base.html' %}
{% load student_filters %}

{% block title %}My Grades & Results{% endblock %}

{% block content %}
<div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2"><i class="bi bi-award"></i> My Grades & Results</h1>
    </div>

    <!-- Performance Summary -->
    {% if published_results %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card shadow-sm border-primary">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted">Overall Percentage</h6>
                        <h3 class="text-primary mb-0">{{ overall_percentage }}%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-success">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted">Exams Passed</h6>
                        <h3 class="text-success mb-0">{{ passed }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-danger">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted">Exams Failed</h6>
                        <h3 class="text-danger mb-0">{{ failed }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-info">
                    <div class="card-body text-center">
                        <h6 class="card-title text-muted">Total Exams</h6>
                        <h3 class="text-info mb-0">{{ total_exams }}</h3>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Published Results -->
    {% if published_results %}
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Published Results ({{ published_results|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Exam Name</th>
                                <th>Course</th>
                                <th>Teacher</th>
                                <th>Marks Obtained</th>
                                <th>Total Marks</th>
                                <th>Pass Marks</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                                <th>Status</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in published_results %}
                                <tr>
                                    <td class="fw-bold">{{ result.exam.name }}</td>
                                    <td>{{ result.exam.subject.course.code }}</td>
                                    <td>{{ result.exam.subject.teacher.get_full_name }}</td>
                                    <td>
                                        {% if result.marks_obtained is not None %}
                                            <strong class="text-primary">{{ result.marks_obtained }}</strong>
                                        {% else %}
                                            <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ result.exam.total_marks }}</td>
                                    <td>{{ result.exam.pass_marks }}</td>
                                    <td>
                                        {% if result.marks_obtained is not None %}
                                            {{ result.marks_obtained|multiply:100|divide:result.exam.total_marks|floatformat:1 }}%
                                        {% else %}
                                            <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.grade %}
                                            <span class="badge bg-info" style="font-size: 1rem; padding: 0.5rem 0.75rem;">{{ result.grade }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.marks_obtained is not None %}
                                            {% if result.marks_obtained >= result.exam.pass_marks %}
                                                <span class="badge bg-success">Pass</span>
                                            {% else %}
                                                <span class="badge bg-danger">Fail</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if result.remarks %}
                                            <small>{{ result.remarks|truncatewords:5 }}</small>
                                        {% else %}
                                            <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Unpublished Results -->
    {% if unpublished_results %}
        <div class="card shadow-lg mb-4 border-warning">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Results Pending Publication ({{ unpublished_results|length }})</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">These exams have been conducted and marks entered, but results are not yet published by the teacher.</p>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Exam Name</th>
                                <th>Course</th>
                                <th>Teacher</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in unpublished_results %}
                                <tr>
                                    <td class="fw-bold">{{ result.exam.name }}</td>
                                    <td>{{ result.exam.subject.course.code }}</td>
                                    <td>{{ result.exam.subject.teacher.get_full_name }}</td>
                                    <td><span class="badge bg-warning">Awaiting Publication</span></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- No Results Message -->
    {% if not published_results and not unpublished_results %}
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            No exam results available yet. They will appear here once exams are conducted and results are published.
        </div>
    {% endif %}
</div>

<style>
    .card {
        transition: box-shadow 0.2s;
    }

    .card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge {
        font-weight: 500;
    }
</style>
{% endblock %}
