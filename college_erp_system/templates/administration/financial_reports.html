{% extends 'base.html' %}
{% load static %}

{% block title %}Financial Reports - Administration{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-4"><i class="fas fa-chart-bar"></i> Financial Reports</h1>
        </div>
    </div>

    <!-- Report Type Selection -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0"><i class="fas fa-file"></i> Report Type</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <form method="GET" class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Select Report</label>
                            <select name="type" class="form-select" onchange="this.form.submit();">
                                <option value="summary" {% if report_type == 'summary' %}selected{% endif %}>Summary Report</option>
                                <option value="defaulters" {% if report_type == 'defaulters' %}selected{% endif %}>Defaulters Report</option>
                                <option value="monthly" {% if report_type == 'monthly' %}selected{% endif %}>Monthly Collection Trend</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Academic Year</label>
                            <input type="text" name="academic_year" class="form-control" value="{{ academic_year }}" placeholder="e.g., 2024-2025">
                        </div>
                    </form>
                </div>
                <div class="col-md-4 text-end">
                    <label class="form-label d-block">Export</label>
                    <a href="?type={{ report_type }}&academic_year={{ academic_year }}&export=csv" class="btn btn-success btn-sm">
                        <i class="fas fa-download"></i> Download CSV
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Report -->
    {% if report_type == 'summary' and summary %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Total Fees</h6>
                    <h3 class="text-primary"><strong>₹{{ summary.total_fees|default:"0" }}</strong></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Collected</h6>
                    <h3 class="text-success"><strong>₹{{ summary.collected|default:"0" }}</strong></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Pending</h6>
                    <h3 class="text-warning"><strong>₹{{ summary.pending|default:"0" }}</strong></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="text-muted">Overdue</h6>
                    <h3 class="text-danger"><strong>₹{{ summary.overdue|default:"0" }}</strong></h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Collection by Fee Type -->
    {% if collection_by_type %}
    <div class="card">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="fas fa-layer-group"></i> Fee Collection by Type</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead class="table-light">
                        <tr>
                            <th>Fee Type</th>
                            <th>Total Amount</th>
                            <th>Collected</th>
                            <th>Pending</th>
                            <th>Collection %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fee_type in collection_by_type %}
                        <tr>
                            <td>{{ fee_type.fee_type }}</td>
                            <td>₹{{ fee_type.total }}</td>
                            <td class="text-success"><strong>₹{{ fee_type.collected|default:"0" }}</strong></td>
                            <td class="text-warning">₹{% widthratio fee_type.total 1 1 %}{% comment %}pending calculation{% endcomment %}</td>
                            <td>
                                {% if fee_type.total > 0 %}
                                <span class="badge bg-info">{{ fee_type.collection_percentage }}%</span>
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Defaulters Report -->
    {% elif report_type == 'defaulters' and defaulters %}
    <div class="card">
        <div class="card-header bg-danger text-white">
            <h6 class="mb-0"><i class="fas fa-exclamation-circle"></i> Defaulters List ({{ defaulters.count }})</h6>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <strong><i class="fas fa-warning"></i> Alert:</strong> The following students have overdue fees.
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Student Name</th>
                            <th>Roll Number</th>
                            <th>Fee Type</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Days Overdue</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fee in defaulters %}
                        <tr class="table-danger">
                            <td><strong>{{ fee.student.get_full_name }}</strong></td>
                            <td>{{ fee.student.student_profile.roll_number }}</td>
                            <td>{{ fee.get_fee_type_display }}</td>
                            <td>₹{{ fee.amount }}</td>
                            <td>{{ fee.due_date|date:"d M Y" }}</td>
                            <td>
                                {% with days_due=now|date:"z"|add:"0"|sub:fee.due_date|date:"z"|add:"0" %}
                                <span class="badge bg-danger">{{ days_due }} days</span>
                                {% endwith %}
                            </td>
                            <td>
                                <span class="badge bg-danger">{{ fee.get_payment_status_display }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Monthly Collection Trend -->
    {% elif report_type == 'monthly' and monthly_data %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-line"></i> Monthly Collection Trend</h6>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="fas fa-calendar"></i> Monthly Details</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead class="table-light">
                        <tr>
                            <th>Month</th>
                            <th>Collection Amount</th>
                            <th>Bar Chart</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for month in monthly_data %}
                        <tr>
                            <td><strong>{{ month.month|floatformat:0|add:""|slice:"-2:" }}</strong></td>
                            <td class="text-success"><strong>₹{{ month.amount }}</strong></td>
                            <td>
                                <div class="progress" style="height: 25px;">
                                    {% with percentage=month.amount|mul:100|div:5000 %}
                                    <div class="progress-bar" style="width: {{ percentage|floatformat:0 }}%">
                                        {% if percentage > 20 %}{{ month.amount }}{% endif %}
                                    </div>
                                    {% endwith %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('monthlyChart');
        if (ctx) {
            const data = {
                labels: [
                    {% for month in monthly_data %}'Month {{ month.month|floatformat:0 }}'{% if not forloop.last %},{% endif %}{% endfor %}
                ],
                datasets: [{
                    label: 'Monthly Collection',
                    data: [
                        {% for month in monthly_data %}{{ month.amount }}{% if not forloop.last %},{% endif %}{% endfor %}
                    ],
                    backgroundColor: 'rgba(75, 192, 75, 0.6)',
                    borderColor: 'rgba(75, 192, 75, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
    });
    </script>
    {% endif %}

    <!-- No Data Message -->
    {% if not summary and not defaulters and not monthly_data and report_type %}
    <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle"></i> No data available for the selected report type and filters.
    </div>
    {% endif %}
</div>
{% endblock %}
